<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YoloPago - Simulaci√≥n de Pago</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .payment-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .payment-header {
            background: linear-gradient(135deg, #C1272D, #A02020);
        }
        .pay-button {
            background: linear-gradient(135deg, #28a745, #20c997);
            transition: all 0.3s;
        }
        .pay-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #C1272D;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .success-checkmark {
            width: 80px;
            height: 80px;
            margin: 0 auto;
        }
        .check-icon {
            width: 80px;
            height: 80px;
            position: relative;
            border-radius: 50%;
            box-sizing: content-box;
            border: 4px solid #4CAF50;
        }
        .check-icon::before {
            top: 3px;
            left: -2px;
            width: 30px;
            transform-origin: 100% 50%;
            border-radius: 100px 0 0 100px;
        }
        .check-icon::after {
            top: 0;
            left: 30px;
            width: 60px;
            transform-origin: 0 50%;
            border-radius: 0 100px 100px 0;
            animation: rotate-circle 4.25s ease-in;
        }
        .check-icon::before, .check-icon::after {
            content: '';
            height: 100px;
            position: absolute;
            background: #FFFFFF;
            transform: rotate(-45deg);
        }
        .icon-line {
            height: 5px;
            background-color: #4CAF50;
            display: block;
            border-radius: 2px;
            position: absolute;
            z-index: 10;
        }
        .icon-line.line-tip {
            top: 46px;
            left: 14px;
            width: 25px;
            transform: rotate(45deg);
            animation: icon-line-tip 0.75s;
        }
        .icon-line.line-long {
            top: 38px;
            right: 8px;
            width: 47px;
            transform: rotate(-45deg);
            animation: icon-line-long 0.75s;
        }
        @keyframes rotate-circle {
            0% { transform: rotate(-45deg); }
            5% { transform: rotate(-45deg); }
            12% { transform: rotate(-405deg); }
            100% { transform: rotate(-405deg); }
        }
        @keyframes icon-line-tip {
            0% { width: 0; left: 1px; top: 19px; }
            54% { width: 0; left: 1px; top: 19px; }
            70% { width: 50px; left: -8px; top: 37px; }
            84% { width: 17px; left: 21px; top: 48px; }
            100% { width: 25px; left: 14px; top: 45px; }
        }
        @keyframes icon-line-long {
            0% { width: 0; right: 46px; top: 54px; }
            65% { width: 0; right: 46px; top: 54px; }
            84% { width: 55px; right: 0px; top: 35px; }
            100% { width: 47px; right: 8px; top: 38px; }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="payment-container w-full max-w-md">
        <!-- Encabezado -->
        <div class="payment-header text-white p-6 text-center">
            <div class="flex items-center justify-center mb-4">
                <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center mr-3">
                    <span class="text-2xl">üí∞</span>
                </div>
                <h1 class="text-2xl font-bold">YoloPago</h1>
            </div>
            <p class="text-white/80">Pago seguro y r√°pido</p>
        </div>

        <!-- Cuerpo del pago -->
        <div class="p-6">
            <!-- Informaci√≥n del pago -->
            <div class="payment-info bg-gray-50 rounded-xl p-4 mb-6 border border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800 mb-3">Detalles del Pago</h2>
                <div class="space-y-2">
                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                        <span class="text-gray-600">Estudiante:</span>
                        <span class="font-semibold" id="student-name">Cargando...</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                        <span class="text-gray-600">Concepto:</span>
                        <span class="font-semibold" id="payment-concept">Cargando...</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                        <span class="text-gray-600">CI Estudiante:</span>
                        <span class="font-mono text-sm" id="student-ci">Cargando...</span>
                    </div>
                    <div class="flex justify-between items-center py-2">
                        <span class="text-gray-600">Transacci√≥n:</span>
                        <span class="font-mono text-sm" id="transaction-id">Cargando...</span>
                    </div>
                </div>
            </div>

            <!-- Monto total -->
            <div class="payment-total bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl p-4 text-center mb-6">
                <div class="text-sm opacity-90">Total a Pagar</div>
                <div class="text-3xl font-bold" id="payment-amount">Bs 0.00</div>
            </div>

            <!-- Formulario de pago -->
            <div id="payment-form-section">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">M√©todo de Pago</h3>
                
                <div class="payment-form space-y-4">
                    <div class="form-group">
                        <label for="payment-method" class="text-gray-700 font-medium mb-2">Selecciona tu app de pago:</label>
                        <select id="payment-method" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-red-500 focus:outline-none transition-colors">
                            <option value="yape">Yape</option>
                            <option value="altoque">Altoque</option>
                            <option value="tigo-money">Tigo Money</option>
                            <option value="bnb">BNB M√≥vil</option>
                            <option value="otro">Otra app</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="phone-number" class="text-gray-700 font-medium mb-2">N√∫mero de tel√©fono:</label>
                        <input type="tel" id="phone-number" placeholder="Ej: 7XXXXXXX" 
                               class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-red-500 focus:outline-none transition-colors">
                    </div>

                    <div class="form-group">
                        <label for="pin-code" class="text-gray-700 font-medium mb-2">C√≥digo PIN (simulado):</label>
                        <input type="password" id="pin-code" placeholder="1234" maxlength="4"
                               class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-red-500 focus:outline-none transition-colors text-center text-2xl">
                    </div>

                    <button id="pay-button" class="pay-button w-full py-4 text-white font-bold rounded-lg text-lg">
                        Confirmar Pago
                    </button>
                </div>
            </div>

            <!-- Estado del pago -->
            <div id="payment-status" class="hidden">
                <div class="text-center py-6">
                    <div class="loading-spinner mb-4" id="loading-spinner"></div>
                    <div class="success-checkmark hidden mb-4" id="success-checkmark">
                        <div class="check-icon">
                            <span class="icon-line line-tip"></span>
                            <span class="icon-line line-long"></span>
                        </div>
                    </div>
                    <h3 class="text-xl font-semibold mb-2" id="status-title">Procesando pago...</h3>
                    <p class="text-gray-600" id="status-message">Por favor espera mientras confirmamos tu pago.</p>
                </div>

                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mt-4 hidden" id="success-message">
                    <div class="flex items-center">
                        <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center mr-3">
                            <span class="text-white text-sm">‚úì</span>
                        </div>
                        <div>
                            <h4 class="font-semibold text-green-800">¬°Pago Exitoso!</h4>
                            <p class="text-green-700 text-sm mt-1">Tu pago ha sido procesado correctamente.</p>
                        </div>
                    </div>
                </div>

                <button id="back-button" class="back-button w-full py-3 bg-green-600 text-white rounded-lg font-medium mt-6 hidden">
                    Volver al Sistema
                </button>
            </div>
        </div>

        <!-- Footer -->
        <div class="bg-gray-100 border-t border-gray-200 p-4 text-center">
            <p class="text-gray-600 text-sm">Sistema de Pagos Seguro - U.E. C√°ndida Mar√≠a de Jes√∫s</p>
            <p class="text-gray-500 text-xs mt-1">Esta es una simulaci√≥n de pago para fines educativos</p>
        </div>
    </div>

    <!-- Firebase Configuration -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAw7DYTj7bZUO2A7meg0WkfoLsMp5ndCjw",
            authDomain: "gestion-fya-ue-candida.firebaseapp.com",
            projectId: "gestion-fya-ue-candida",
            storageBucket: "gestion-fya-ue-candida.firebasestorage.app",
            messagingSenderId: "842332234295",
            appId: "1:842332234295:web:5946b2049900ea9b2415b2"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>

    <!-- Firebase Services CORREGIDO -->
    <script>
        const firebaseServices = {
            students: {
                async getStudentByCI(ci) {
                    try {
                        const snapshot = await db.collection('students')
                            .where('ci', '==', ci)
                            .limit(1)
                            .get();
                        
                        if (snapshot.empty) return null;
                        
                        const doc = snapshot.docs[0];
                        return { id: doc.id, ...doc.data() };
                    } catch (error) {
                        console.error('Error obteniendo estudiante:', error);
                        return null;
                    }
                }
            },

            payments: {
                async addPayment(studentId, concept, paymentData) {
                    try {
                        const studentRef = db.collection('students').doc(studentId);
                        
                        const result = await db.runTransaction(async (transaction) => {
                            const studentDoc = await transaction.get(studentRef);
                            if (!studentDoc.exists) throw new Error('Estudiante no encontrado');
                            
                            const student = studentDoc.data();
                            const payments = student.payments || {};
                            const conceptPayments = payments[concept] || { payments: [], total: 0 };
                            
                            // CORREGIDO: No usar FieldValue.serverTimestamp() dentro del array
                            const newPayment = {
                                date: paymentData.date,
                                amount: paymentData.amount,
                                method: paymentData.method || 'manual',
                                transactionId: paymentData.transactionId,
                                timestamp: new Date().toISOString() // Usar fecha normal en lugar de serverTimestamp
                            };
                            
                            conceptPayments.payments.push(newPayment);
                            conceptPayments.total += paymentData.amount;
                            payments[concept] = conceptPayments;
                            
                            transaction.update(studentRef, { 
                                payments,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp() // Solo aqu√≠ se usa serverTimestamp
                            });
                            
                            return { success: true };
                        });
                        
                        return { success: true };
                    } catch (error) {
                        console.error('Error registrando pago:', error);
                        return { success: false, error: error.message };
                    }
                }
            },

            transactions: {
                async updateTransaction(transactionId, updates) {
                    try {
                        // Buscar la transacci√≥n por transactionId
                        const snapshot = await db.collection('transactions')
                            .where('transactionId', '==', transactionId)
                            .limit(1)
                            .get();
                        
                        if (snapshot.empty) {
                            throw new Error('Transacci√≥n no encontrada');
                        }
                        
                        const doc = snapshot.docs[0];
                        await db.collection('transactions').doc(doc.id).update({
                            ...updates,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        return { success: true };
                    } catch (error) {
                        console.error('Error actualizando transacci√≥n:', error);
                        return { success: false, error: error.message };
                    }
                }
            }
        };
    </script>

    <!-- Main Script CORREGIDO -->
    <script>
        // Obtener par√°metros de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const transactionId = urlParams.get('transaction');
        const studentCi = urlParams.get('ci');
        const amount = parseFloat(urlParams.get('amount')) || 0;
        const concept = urlParams.get('concept');
        const studentName = decodeURIComponent(urlParams.get('student') || '');

        // Elementos del DOM
        const studentNameEl = document.getElementById('student-name');
        const paymentConceptEl = document.getElementById('payment-concept');
        const studentCiEl = document.getElementById('student-ci');
        const transactionIdEl = document.getElementById('transaction-id');
        const paymentAmountEl = document.getElementById('payment-amount');
        const payButton = document.getElementById('pay-button');
        const paymentFormSection = document.getElementById('payment-form-section');
        const paymentStatus = document.getElementById('payment-status');
        const loadingSpinner = document.getElementById('loading-spinner');
        const successCheckmark = document.getElementById('success-checkmark');
        const statusTitle = document.getElementById('status-title');
        const statusMessage = document.getElementById('status-message');
        const successMessage = document.getElementById('success-message');
        const backButton = document.getElementById('back-button');

        // Inicializar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            // Mostrar informaci√≥n del pago
            studentNameEl.textContent = studentName || 'No especificado';
            paymentConceptEl.textContent = concept || 'Mensualidad';
            studentCiEl.textContent = studentCi || 'No especificado';
            transactionIdEl.textContent = transactionId || 'No especificado';
            paymentAmountEl.textContent = `Bs ${amount.toFixed(2)}`;

            // Configurar evento del bot√≥n de pago
            payButton.addEventListener('click', processPayment);
            
            // Configurar evento del bot√≥n de volver
            backButton.addEventListener('click', function() {
                // Notificar a la ventana principal que el pago se complet√≥
                if (window.opener && !window.opener.closed) {
                    window.opener.postMessage({
                        type: 'PAYMENT_COMPLETED',
                        studentCi: studentCi,
                        amount: amount,
                        concept: concept,
                        transactionId: transactionId
                    }, '*');
                }
                
                // Cerrar esta ventana despu√©s de un breve retraso
                setTimeout(() => {
                    if (window.opener && !window.opener.closed) {
                        window.close();
                    } else {
                        // Si no hay ventana principal, redirigir
                        window.location.href = window.location.origin + window.location.pathname.replace('pago-simulado.html', 'index.html');
                    }
                }, 500);
            });

            // Validaci√≥n en tiempo real del n√∫mero de tel√©fono
            document.getElementById('phone-number').addEventListener('input', function(e) {
                this.value = this.value.replace(/[^0-9]/g, '').slice(0, 8);
            });

            // Validaci√≥n en tiempo real del PIN
            document.getElementById('pin-code').addEventListener('input', function(e) {
                this.value = this.value.replace(/[^0-9]/g, '').slice(0, 4);
            });
        });

        // Procesar el pago - VERSI√ìN CORREGIDA
        async function processPayment() {
            const phoneNumber = document.getElementById('phone-number').value;
            const pinCode = document.getElementById('pin-code').value;
            const paymentMethod = document.getElementById('payment-method').value;

            // Validaciones b√°sicas
            if (!phoneNumber || phoneNumber.length < 8) {
                alert('Por favor ingresa un n√∫mero de tel√©fono v√°lido (8 d√≠gitos)');
                return;
            }

            if (!pinCode || pinCode.length !== 4 || isNaN(pinCode)) {
                alert('Por favor ingresa un c√≥digo PIN de 4 d√≠gitos num√©ricos');
                return;
            }

            // Mostrar estado de procesamiento
            paymentFormSection.classList.add('hidden');
            paymentStatus.classList.remove('hidden');
            loadingSpinner.classList.remove('hidden');
            statusTitle.textContent = 'Procesando pago...';
            statusMessage.textContent = 'Por favor espera mientras confirmamos tu pago.';

            try {
                // Simular procesamiento del pago (2 segundos)
                await new Promise(resolve => setTimeout(resolve, 2000));

                console.log('Buscando estudiante con CI:', studentCi);
                
                // Buscar el estudiante usando el servicio de Firebase
                const student = await firebaseServices.students.getStudentByCI(studentCi);
                console.log('Resultado de b√∫squeda:', student);
                
                if (!student) {
                    throw new Error(`No se encontr√≥ estudiante con CI: ${studentCi}`);
                }

                console.log('Estudiante encontrado:', student.name, 'ID:', student.id);

                // Registrar el pago en el estudiante
                const paymentResult = await firebaseServices.payments.addPayment(student.id, concept, {
                    date: new Date().toISOString().split('T')[0],
                    amount: amount,
                    method: `qr_${paymentMethod}`,
                    transactionId: transactionId
                });

                if (!paymentResult.success) {
                    throw new Error('Error registrando pago en el estudiante: ' + paymentResult.error);
                }

                console.log('Pago registrado exitosamente para el estudiante');

                // Buscar y actualizar la transacci√≥n en Firebase
                try {
                    const transactionsSnapshot = await db.collection('transactions')
                        .where('transactionId', '==', transactionId)
                        .limit(1)
                        .get();

                    if (!transactionsSnapshot.empty) {
                        const transactionDoc = transactionsSnapshot.docs[0];
                        
                        // Actualizar transacci√≥n en Firebase
                        await db.collection('transactions').doc(transactionDoc.id).update({
                            status: 'completed',
                            paymentMethod: paymentMethod,
                            phoneNumber: phoneNumber,
                            completedAt: new Date().toISOString(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        console.log('Transacci√≥n actualizada en Firebase');
                    } else {
                        console.warn('Transacci√≥n no encontrada:', transactionId);
                        // Crear la transacci√≥n si no existe
                        await db.collection('transactions').add({
                            transactionId: transactionId,
                            studentCi: studentCi,
                            studentName: studentName,
                            amount: amount,
                            concept: concept,
                            status: 'completed',
                            paymentMethod: paymentMethod,
                            phoneNumber: phoneNumber,
                            completedAt: new Date().toISOString(),
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        console.log('Transacci√≥n creada en Firebase');
                    }
                } catch (transactionError) {
                    console.warn('Error actualizando transacci√≥n:', transactionError);
                    // Continuar aunque falle la transacci√≥n, lo importante es el pago
                }

                // Mostrar √©xito
                loadingSpinner.classList.add('hidden');
                successCheckmark.classList.remove('hidden');
                statusTitle.textContent = '¬°Pago Completado!';
                statusMessage.textContent = 'Tu pago ha sido procesado exitosamente.';
                successMessage.classList.remove('hidden');

                // Notificar a la ventana principal
                try {
                    if (window.opener && !window.opener.closed) {
                        window.opener.postMessage({
                            type: 'PAYMENT_COMPLETED',
                            studentCi: studentCi,
                            amount: amount,
                            concept: concept,
                            transactionId: transactionId,
                            studentName: studentName
                        }, '*');
                        console.log('Mensaje enviado a la ventana principal');
                    }
                } catch (error) {
                    console.log('No se pudo comunicar con la ventana principal:', error);
                }

                // Mostrar bot√≥n de volver despu√©s de 2 segundos
                setTimeout(() => {
                    backButton.classList.remove('hidden');
                }, 2000);

            } catch (error) {
                console.error('Error completo procesando pago:', error);
                // Mostrar error
                loadingSpinner.classList.add('hidden');
                statusTitle.textContent = 'Error en el Pago';
                statusMessage.textContent = 'Hubo un problema al procesar tu pago: ' + error.message;
                statusTitle.classList.add('text-red-600');
                
                // Mostrar bot√≥n para reintentar
                backButton.textContent = 'Reintentar Pago';
                backButton.classList.remove('hidden');
                backButton.onclick = function() {
                    window.location.reload();
                };
            }
        }
    </script>
</body>
</html>